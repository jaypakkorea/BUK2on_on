{% extends 'base.html' %}
{% load static %}

{% block content %}
<div style="margin:8rem;">

<div class="container" >
  <h1 class='section_title' style="margin-top:1rem;">PROFILE</h1>

  <div style='display: flex;'>
    <div style="justify-content: center; align-items: center; align-self: center; ">
      {% if person.profile_pic %}
          <img src="{{person.profile_pic.url}}" alt="no image"  width="150" height="150" style="border-radius : 70%; overflow:hidden; margin-right:5rem;">
      {% else %}
          <img src=" {% static 'default_avatar2.jpg' %} " alt="no image"  width="150" height="150" style="border-radius : 70%; overflow:hidden; margin-right:5rem; ">
      {% endif %}
    </div>


    <section style='display: flex; flex-direction:column; justify-content:left; align-itmes:left; margin-top:1.3rem;' >
      <div class= "d-flex flex-row justify-content-left  align-itmes-left row-6 " style='margin-bottom:2rem;'>
        <h3 style='margin-right:2rem;'>
            {{person.username|upper}}
        </h3>

        {% if request.user != person %}
        <form id="follow-form" data-user-id="{{person.pk}}" style='display: inline; '>
            {% csrf_token %}
            {% if request.user in person.followers.all %}
            <input type="submit" value="UNFOLLOW" class="btn btn-light btn-sm" >
            {% else %}
            <input type="submit" value="FOLLOW" class="btn btn-outline-light btn-sm">
            {% endif %}
        </form>   
        {% endif %} 
      </div>
      <div class="d-flex flex-row row-6" style="font-size:0.8rem; justify-content:space-round; align-itmes:center;">
        <div class="d-flex row-4 row-md-4" >
          FOLLOWING &nbsp&nbsp <span id="followings-count">{{person.followings.all|length}}</span> &nbsp&nbsp&nbsp&nbsp
        </div>
        <div class="d-flex row-4 row-md-4">
          FOLLOWER  &nbsp&nbsp <span id="followers-count">{{person.followers.all|length}}</span>&nbsp&nbsp&nbsp&nbsp
        </div>
        <div class="d-flex row-4 row-md-4">
          RECOMMENDS &nbsp&nbsp <span>{{person.restaurant_set.all|length}}</span>&nbsp&nbsp&nbsp&nbsp 
      </div>
    </div>
      
    {% comment %} <div>
        {% if profiles.instagram_url %}
        <p>Instagram :
        <a  href="{{profiles.instagram_url}}" class="btn_submit" style="background: none; border:none; padding:0;"><i class="fa-brands fa-instagram fa-xl" style="color:white;"></i></a>
        </p>
        {% endif %}
        {% if profiles.youtube_url %}
        <p>Youtube :
            <a  href="{{profiles.youtube_url}}" class="btn_submit" style="background: none; border:none; padding:0;"><i class="fa-brands fa-youtube fa-xl" style="color:white;"></i></a>
        {% endif %}
    </div> {% endcomment %}
  </section>
</div>
<div style=" border:1px solid none; height:5rem;" ></div>



<hr>
<div style=" border:1px solid none; height:1.2rem;" ></div>

<h3 style="bottom:2rem; display:inline;"><b>{{person.username|upper}} 's </b></h3>
<h2 style="bottom:2rem; display:inline; font-size:1.3rem;">recommends</h2>
<div style=" border:1px solid none; height:2rem;" ></div>



{% for recommend  in person.restaurant_set.all  %}
  {% if recommend.stars == 3 %}
    <div style="margin-bottom:1.3rem;">{{recommend.name}}  <span style='margin-left:1rem ;'>★★★</span></div>
  {% elif recommend.stars == 2 %}
    <div style="margin-bottom:1.3rem;">{{recommend.name}}  <span style='margin-left:1rem ;'>★★</span></div>
  {% elif recommend.stars == 1 %}
    <div style="margin-bottom:1.3rem;">{{recommend.name}}  <span style='margin-left:1rem ;'>★</span></div>
  {% elif recommend.stars == 0 %}
    <div style="margin-bottom:1.3rem;">{{recommend.name}}  <span style='margin-left:1rem ;'>none</span></div>
  {% endif %} 
{% endfor %}


<hr>

<a href="{% url 'accounts:update' %}" style="color:gray;" class="btn btn-outline-secondary">UPDATE ACCOUNT</a>

<hr>
<a href="{% url 'buk2on_on:index' %}"><input type="submit" value="BACK"  ></a>
</div>

{% endblock content %}


{% block script %}
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    const form = document.querySelector('#follow-form')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    form.addEventListener('submit', function(event){
      event.preventDefault()
      const userId = event.target.dataset.userId

      axios({
        method :'post',
        url : `/accounts/${userId}/follow/`,
        headers : {'X-CSRFToken' : csrftoken,}
      })
      .then((response) => {
        const isFollowed = response.data.is_followed
        console.log(isFollowed)

        const followBtn = document.querySelector('#follow-form > input[type=submit]')
        if (isFollowed === true) {
          followBtn.value = 'unfollow'
        } else {
          followBtn.value = 'follow'
        }
        const followersCountTag = document.querySelector('#followers-count')
        const followingsCountTag = document.querySelector('#followings-count')
        const followersCount = response.data.followers_count
        const followingsCount = response.data.followings_count
        followersCountTag.innerText = followersCount
        followingsCountTag.innerText = followingsCount
      })
      .catch((error) => {
        console.log(error.response)
      })
    })

  </script>
{% endblock script %}
